upstream {{ upstreamName }} {
    {% for target in upstreamTargets %}
    server {{ target.host }}:{{ target.port }} weight={{ target.weight }};
    {% endfor %}
}

server {
    listen 80;
    server_name {{ domain }};

    # Include security headers
    # include /etc/nginx/snippets/security_headers.conf;

    location / {
        proxy_pass http://{{ upstreamName }};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Tenant-Id "{{ tenantId }}";

        # Rate limiting logic here
        {% if edgePolicy.rateLimit %}
        # limit_req ...
        {% endif %}

        {% if edgePolicy.headers %}
        {% for key, value in edgePolicy.headers %}
        add_header {{ key }} "{{ value }}" always;
        {% endfor %}
        {% endif %}
    }
}
