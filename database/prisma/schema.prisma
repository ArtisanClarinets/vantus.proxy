generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- Better Auth Models ---

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified Boolean?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions      Session[]
  accounts      Account[]
  apiKeys       ApiKey[]

  // Application relations
  memberships   Membership[]
  auditLogs     AuditLog[]
  alerts        Alert[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  userId       String
  accountId    String
  providerId   String
  accessToken  String?
  refreshToken String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope        String?
  idToken      String?
  password     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@map("verification")
}

// --- IAM & Developer Platform ---

model ApiKey {
  id          String    @id @default(cuid())
  key         String    @unique // Hashed
  prefix      String    // Displayable prefix
  name        String
  userId      String
  tenantId    String?   // Scoped to tenant (optional)
  scopes      String    // Comma-separated scopes: "read:config,write:config"
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant      Tenant?   @relation(fields: [tenantId], references: [id])

  @@map("api_key")
}

// --- Application Models ---

enum Role {
  OWNER
  ADMIN
  OPERATOR
  VIEWER
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  ARCHIVED
}

model Tenant {
  id        String       @id @default(cuid())
  slug      String       @unique
  name      String
  status    TenantStatus @default(ACTIVE)

  // Commercial / Billing
  plan      String       @default("free") // "free", "pro", "enterprise"
  stripeCustomerId String?
  subscriptionId   String?

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  domains           Domain[]
  upstreamPools     UpstreamPool[]
  edgePolicies      EdgePolicy[]
  deployments       DeploymentHistory[]
  memberships       Membership[]
  auditLogs         AuditLog[]
  apiKeys           ApiKey[]
  invoices          Invoice[]

  @@map("tenant")
}

model Domain {
  id        String   @id @default(cuid())
  name      String   @unique
  tenantId  String
  isPrimary Boolean  @default(false)
  verified  Boolean  @default(false)
  dnsRecord String?  // "TXT _vantus-challenge=..."

  // TLS Configuration
  tlsEnabled     Boolean @default(true)
  forceHttps     Boolean @default(true)
  hstsEnabled    Boolean @default(true)
  minTlsVersion  String  @default("1.2") // "1.2", "1.3"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  certificateEvents CertificateEvent[]

  @@map("domain")
}

model UpstreamPool {
  id        String   @id @default(cuid())
  name      String
  targets   Json     // [{host, port, weight, priority}]
  protocol  String   @default("http") // "http", "https", "h2c"

  // Health Checks
  healthCheckPath     String?
  healthCheckInterval Int     @default(10)

  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("upstream_pool")
}

model EdgePolicy {
  id          String   @id @default(cuid())
  tenantId    String   @unique

  // Security
  headers     Json?
  rateLimit   Json?    // { rps, burst, key }
  cors        Json?
  ipAllowlist Json?

  // WAF & Bot (Enterprise)
  wafEnabled  Boolean  @default(false)
  botMode     String   @default("off") // "off", "challenge", "block"
  geoBlock    Json?    // ["CN", "RU"]

  // Performance
  cacheTtl    Int      @default(0) // seconds
  compression Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("edge_policy")
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  role      Role     @default(VIEWER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("membership")
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String
  tenantId  String?
  action    String   // "config.update", "domain.create"
  metadata  Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  actor     User     @relation(fields: [actorId], references: [id])
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@map("audit_log")
}

// --- Edge Fleet Management ---

model EdgeCluster {
  id        String   @id @default(cuid())
  name      String
  region    String
  provider  String   // "aws", "gcp", "bare-metal"
  nodes     EdgeNode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("edge_cluster")
}

model EdgeNode {
  id           String   @id @default(cuid())
  clusterId    String
  hostname     String
  ipAddress    String
  version      String
  status       String   // "HEALTHY", "DRAINING", "OFFLINE"
  lastSeenAt   DateTime
  configHash   String?  // For drift detection

  cluster      EdgeCluster @relation(fields: [clusterId], references: [id])

  @@map("edge_node")
}

model DeploymentHistory {
  id        String   @id @default(cuid())
  tenantId  String?
  hash      String
  status    String   // "PENDING", "SUCCESS", "FAILED", "ROLLBACK"
  strategy  String   @default("atomic") // "atomic", "canary"
  logs      String?  @db.Text
  createdAt DateTime @default(now())

  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@map("deployment_history")
}

model CertificateEvent {
  id        String   @id @default(cuid())
  domainId  String
  status    String   // "ISSUED", "FAILED", "RENEWED"
  provider  String   @default("letsencrypt")
  message   String?
  expiresAt DateTime?
  createdAt DateTime @default(now())

  domain    Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@map("certificate_event")
}

// --- Observability & Billing ---

model Alert {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "usage", "health", "security"
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("alert")
}

model Invoice {
  id        String   @id @default(cuid())
  tenantId  String
  amount    Int      // In cents
  currency  String   @default("USD")
  status    String   // "PAID", "DUE"
  pdfUrl    String?
  periodStart DateTime
  periodEnd   DateTime
  createdAt DateTime @default(now())

  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@map("invoice")
}

model Incident {
  id        String   @id @default(cuid())
  title     String
  status    String   // "INVESTIGATING", "RESOLVED"
  severity  String   // "MAJOR", "MINOR"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("incident")
}
